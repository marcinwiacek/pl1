<html>

<head>
</head>

<body>
    <canvas></canvas>
</body>

<script>
    const bytesPerInstruction = 6;
    const maxProcess = 100;
    const registerNum = 11;

    memory = new Uint8Array(1024 * 1024);
    registers = new Uint32Array(2 * registerNum * maxProcess); // x processes, every with 16-bit program registers, first register is program counter
    intHandlers = new Uint8Array(256);
    processNum = 0;

    const REGINT = 1; //rint     register int support    int_number
    const INT = 2; //int      execute int             int_number, mem position, length
    const INTRET = 3; //intret   return from int
    const WINT = 4; //wint     wait for int
    const PROC = 5; //proc     separate and start process from memory  mem position, length
    const END = 6; //end      end process
    const JUMP = 7; //jmp      jump                                    address
    const CMPRRTRUE = 8; //cmptrue      compare memory with memory, when not the same, jump to      address1, address2, jump
    const CMPFALSE = 9;
    const CMPTRUER = 10;
    const ADDRR = 11;

    const NAMES=['REGINT','INT','INTRET','WINT','PROC','END','JUMP','CMPRRTRUE','CMPFALSE','CMPTRUER','ADDRR'];

    function bootloader() {
	for (i=0;i<2*registerNum*maxProcess;i++) registers[i] = 256;

        const screenProcessSize = 1024 * 1024 + 6*bytesPerInstruction;
	const bootloaderCodeSize = 4*bytesPerInstruction+5;

        const bootloaderCode = [
            PROC, 0, 0, bootloaderCodeSize, 0, 0, //  0,    bootloader_length
            PROC, 0, 0, bootloaderCodeSize+1, screenProcessSize / 256, screenProcessSize % 256, //  screen_code_start,   screen_code_length
            INT, 2, 0, 4*5+1, 0, 4*5+5, //
            END, 0, 0, 0, 0, 0,
            'h', 'a', 'l', 'l', 'o',
        ];

        const screenCode = [
            REGINT, 2, 0, 0, 0, 0, //register int 2
            CMPRRTRUE, 1, 2, 0, 0, 0, //if address from register 1 = address from register 2  RINT
            INTRET, 0, 0, 0, 0, 0,
            ADDRR, 1, 1, 0, 0, 0, // add to register 1 value 1
            JUMP, 0, 1, 0, 0, 0   // jump to CMPTRUER
	];

        const screenRAM = new Uint8Array(1024 * 1024);

        let pos = 0;
        for (i = 0; i<bootloaderCode.length; i++) {
            memory[pos++] = bootloaderCode[i];
        }
        for (i = 0; i<screenCode.length; i++) {
            memory[pos++] = screenCode[i];
        }
        for (i = 0; i<screenRAM.length; i++) {
            memory[pos++] = screenRAM[i];
        }

	registers[0] = 1;
    }

    function execute() {
	for (i=0;i<10;i++) {
		address = registers[processNum*registerNum]-1;
		console.log("address = "+address+" instruction = "+memory[address]+ " "+NAMES[memory[address]-1]+" "+memory[address+1]+" "+memory[address+2]+" "+memory[address+3]+" "+memory[address+4]);
		switch(memory[address]) {
		case PROC:
		    for (j=0;j<maxProcess;j++) {
			if (registers[j*registerNum]==256) {
			    console.log("registering as process "+j);
			    registers[j*registerNum] = j;
			    
			}
		    }
		case INT:
		    
		}
		registers[processNum*registerNum]+=bytesPerInstruction;
		processNum++;
		if (registers[processNum*registerNum+1]==0) {
		    processNum = 0;
		}
	}
    }

    bootloader();
    execute();
</script>

</html>